name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    env:
      OWNER: "0x3F32bC09d41eE699844F8296e806417D6bf61Bba"
      CURATOR: "0x3F32bC09d41eE699844F8296e806417D6bf61Bba"
      ALLOCATOR: "0x3F32bC09d41eE699844F8296e806417D6bf61Bba"
      SENTINEL: "0x3F32bC09d41eE699844F8296e806417D6bf61Bba"
      VAULT_NAME: "sky.money USDS Risk Capital"
      VAULT_SYMBOL: "skyMoneyUsdsRiskCapital"
      VAULT_ADDRESS: "0xAE57b2874673C7E0f5462B598220775017094E8f"

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Run deploy script tests
        run: |
          anvil --fork-url ${{ secrets.RPC_URL }} &
          sleep 5
          forge test --match-contract DeployScriptTest --fork-url http://localhost:8545 -vvvv
          pkill anvil

      - name: Run deployed vault tests
        run: |
          anvil --fork-url ${{ secrets.RPC_URL }} &
          sleep 5
          forge test --match-contract DeployedVaultTest --fork-url http://localhost:8545 -vvvv
          pkill anvil
